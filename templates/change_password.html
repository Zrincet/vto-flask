{% extends "base.html" %}

{% block title %}修改密码 - VTO设备管理系统{% endblock %}

{% block page_title %}修改密码{% endblock %}

{% block topbar_actions %}
<div class="btn-group">
                <a href="{{ url_for('device.dashboard') }}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left"></i>
        <span class="d-none d-sm-inline">返回首页</span>
    </a>
</div>
{% endblock %}

{% block content %}
<div class="password-container">
    <!-- 页面标题 -->
    <div class="page-header">
        <h1>修改密码</h1>
        <p class="page-subtitle">为了账户安全，请定期修改您的密码</p>
    </div>
    
    <!-- 修改密码表单 -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-shield-alt text-primary"></i>
                密码修改
            </h5>
        </div>
        <div class="card-body">
            <form method="POST" class="password-form">
                <div class="row g-4">
                    <div class="col-12">
                        <div class="form-group">
                            <label for="current_password" class="form-label">
                                <i class="fas fa-lock text-muted"></i>
                                当前密码
                                <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <input type="password" class="form-control" id="current_password" name="current_password" placeholder="请输入当前密码" required>
                                <button class="btn btn-outline-secondary toggle-password" type="button" data-target="current_password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">请输入您当前的密码进行验证</div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="form-group">
                            <label for="new_password" class="form-label">
                                <i class="fas fa-key text-success"></i>
                                新密码
                                <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-key"></i>
                                </span>
                                <input type="password" class="form-control" id="new_password" name="new_password" placeholder="请输入新密码" required minlength="6">
                                <button class="btn btn-outline-secondary toggle-password" type="button" data-target="new_password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">密码长度至少6位，建议包含字母和数字</div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="form-group">
                            <label for="confirm_password" class="form-label">
                                <i class="fas fa-key text-warning"></i>
                                确认新密码
                                <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-key"></i>
                                </span>
                                <input type="password" class="form-control" id="confirm_password" name="confirm_password" placeholder="请再次输入新密码" required minlength="6">
                                <button class="btn btn-outline-secondary toggle-password" type="button" data-target="confirm_password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">请再次输入新密码进行确认</div>
                        </div>
                    </div>
                </div>
                
                <!-- 密码强度指示器 -->
                <div class="password-strength-container mt-4">
                    <div class="password-strength-header">
                        <label class="form-label">密码强度</label>
                        <span class="strength-text" id="strengthText">请输入密码</span>
                    </div>
                    <div class="password-strength-bar">
                        <div class="strength-meter" id="strengthMeter"></div>
                    </div>
                </div>
                
                <!-- 密码要求 -->
                <div class="password-requirements mt-4">
                    <h6 class="requirements-title">密码要求</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="requirement-item" id="length-req">
                                <i class="fas fa-circle requirement-icon"></i>
                                <span class="requirement-text">至少6个字符</span>
                            </div>
                            <div class="requirement-item" id="letter-req">
                                <i class="fas fa-circle requirement-icon"></i>
                                <span class="requirement-text">包含字母</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="requirement-item" id="number-req">
                                <i class="fas fa-circle requirement-icon"></i>
                                <span class="requirement-text">包含数字（推荐）</span>
                            </div>
                            <div class="requirement-item" id="special-req">
                                <i class="fas fa-circle requirement-icon"></i>
                                <span class="requirement-text">包含特殊字符（推荐）</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        修改密码
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="resetFormBtn">
                        <i class="fas fa-undo"></i>
                        重置表单
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 安全提示 -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-shield-alt text-success"></i>
                安全提示
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="security-tip">
                        <div class="tip-icon">
                            <i class="fas fa-lightbulb text-warning"></i>
                        </div>
                        <div class="tip-content">
                            <h6>密码建议</h6>
                            <ul>
                                <li>使用字母、数字和特殊字符的组合</li>
                                <li>避免使用常见词汇或个人信息</li>
                                <li>定期更换密码</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="security-tip">
                        <div class="tip-icon">
                            <i class="fas fa-exclamation-triangle text-danger"></i>
                        </div>
                        <div class="tip-content">
                            <h6>注意事项</h6>
                            <ul>
                                <li>请不要在公共场所输入密码</li>
                                <li>密码修改后请妥善保管</li>
                                <li>如有异常请及时联系管理员</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.password-container {
    max-width: 800px;
    margin: 0 auto;
}

.input-group .toggle-password {
    border-left: none;
}

.input-group .form-control:focus {
    border-color: #2563eb;
    box-shadow: none;
}

.input-group .form-control:focus + .toggle-password {
    border-color: #2563eb;
}

.password-strength-container {
    background: #f8fafc;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e5e7eb;
}

.password-strength-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.password-strength-header .form-label {
    margin-bottom: 0;
    font-weight: 600;
}

.strength-text {
    font-size: 0.875rem;
    font-weight: 600;
}

.password-strength-bar {
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
}

.strength-meter {
    height: 100%;
    width: 0;
    transition: all 0.3s ease;
    border-radius: 4px;
}

.strength-meter.weak {
    background: #dc2626;
    width: 25%;
}

.strength-meter.fair {
    background: #f59e0b;
    width: 50%;
}

.strength-meter.good {
    background: #3b82f6;
    width: 75%;
}

.strength-meter.strong {
    background: #10b981;
    width: 100%;
}

.strength-text {
    color: #6b7280;
}

.strength-meter.weak + .strength-text {
    color: #dc2626;
}

.strength-meter.fair + .strength-text {
    color: #f59e0b;
}

.strength-meter.good + .strength-text {
    color: #3b82f6;
}

.strength-meter.strong + .strength-text {
    color: #10b981;
}

.password-requirements {
    background: #f8fafc;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e5e7eb;
}

.requirements-title {
    color: #374151;
    font-weight: 600;
    margin-bottom: 1rem;
}

.requirement-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.requirement-icon {
    width: 12px;
    height: 12px;
    margin-right: 0.5rem;
    color: #d1d5db;
    font-size: 0.75rem;
}

.requirement-text {
    font-size: 0.875rem;
    color: #6b7280;
}

.requirement-item.met .requirement-icon {
    color: #10b981;
}

.requirement-item.met .requirement-text {
    color: #059669;
}

.form-actions {
    display: flex;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
}

.security-tip {
    display: flex;
    gap: 1rem;
    background: #f8fafc;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e5e7eb;
    height: 100%;
}

.tip-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border-radius: 50%;
    border: 1px solid #e5e7eb;
}

.tip-content h6 {
    margin-bottom: 0.5rem;
    color: #374151;
}

.tip-content ul {
    margin-bottom: 0;
    padding-left: 1.2rem;
}

.tip-content li {
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
    color: #6b7280;
}

/* 移动端适配 */
@media (max-width: 768px) {
    .form-actions {
        flex-direction: column;
    }
    
    .form-actions .btn {
        width: 100%;
    }
    
    .password-strength-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
    }
    
    .security-tip {
        flex-direction: column;
        text-align: center;
    }
    
    .tip-icon {
        margin: 0 auto;
    }
}

@media (max-width: 480px) {
    .input-group .toggle-password {
        padding: 0.375rem 0.75rem;
    }
    
    .input-group .toggle-password i {
        font-size: 0.875rem;
    }
    
    .requirement-item {
        font-size: 0.8rem;
    }
    
    .password-requirements, .password-strength-container {
        padding: 0.75rem;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordForm = document.querySelector('.password-form');
    const currentPasswordInput = document.getElementById('current_password');
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const strengthMeter = document.getElementById('strengthMeter');
    const strengthText = document.getElementById('strengthText');
    const resetFormBtn = document.getElementById('resetFormBtn');
    
    // 自动聚焦当前密码输入框
    currentPasswordInput.focus();
    
    // 密码显示/隐藏切换
    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.dataset.target;
            const targetInput = document.getElementById(targetId);
            const icon = this.querySelector('i');
            
            if (targetInput.type === 'password') {
                targetInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                targetInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    });
    
    // 密码强度检测
    newPasswordInput.addEventListener('input', function() {
        const password = this.value;
        const strength = checkPasswordStrength(password);
        
        // 更新强度指示器
        strengthMeter.className = `strength-meter ${strength.class}`;
        strengthText.textContent = strength.text;
        
        // 更新密码要求检查
        updatePasswordRequirements(password);
    });
    
    // 确认密码验证
    confirmPasswordInput.addEventListener('input', function() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = this.value;
        
        if (confirmPassword && newPassword !== confirmPassword) {
            this.setCustomValidity('密码不匹配');
            this.classList.add('is-invalid');
        } else {
            this.setCustomValidity('');
            this.classList.remove('is-invalid');
        }
    });
    
    // 表单提交前验证
    passwordForm.addEventListener('submit', function(e) {
        const currentPassword = currentPasswordInput.value.trim();
        const newPassword = newPasswordInput.value.trim();
        const confirmPassword = confirmPasswordInput.value.trim();
        
        if (!currentPassword || !newPassword || !confirmPassword) {
            e.preventDefault();
            showMessage('error', '请填写所有字段');
            return false;
        }
        
        if (newPassword !== confirmPassword) {
            e.preventDefault();
            showMessage('error', '新密码与确认密码不匹配');
            confirmPasswordInput.focus();
            return false;
        }
        
        if (newPassword.length < 6) {
            e.preventDefault();
            showMessage('error', '密码长度至少6位');
            newPasswordInput.focus();
            return false;
        }
        
        if (newPassword === currentPassword) {
            e.preventDefault();
            showMessage('error', '新密码不能与当前密码相同');
            newPasswordInput.focus();
            return false;
        }
        
        // 显示提交状态
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 修改中...';
        
        // 如果修改失败，恢复按钮状态
        setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> 修改密码';
        }, 5000);
    });
    
    // 重置表单按钮
    resetFormBtn.addEventListener('click', function() {
        if (confirm('确定要重置表单吗？')) {
            passwordForm.reset();
            strengthMeter.className = 'strength-meter';
            strengthText.textContent = '请输入密码';
            updatePasswordRequirements('');
            currentPasswordInput.focus();
            showMessage('info', '表单已重置');
        }
    });
    
    // 密码强度检测函数
    function checkPasswordStrength(password) {
        if (password.length === 0) {
            return { class: '', text: '请输入密码' };
        }
        
        let score = 0;
        
        // 长度检查
        if (password.length >= 6) score += 1;
        if (password.length >= 8) score += 1;
        
        // 字符类型检查
        if (/[a-zA-Z]/.test(password)) score += 1;
        if (/[0-9]/.test(password)) score += 1;
        if (/[^a-zA-Z0-9]/.test(password)) score += 1;
        
        // 大小写检查
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score += 1;
        
        switch (score) {
            case 0:
            case 1:
                return { class: 'weak', text: '弱' };
            case 2:
                return { class: 'fair', text: '一般' };
            case 3:
            case 4:
                return { class: 'good', text: '良好' };
            case 5:
            case 6:
                return { class: 'strong', text: '强' };
            default:
                return { class: '', text: '请输入密码' };
        }
    }
    
    // 更新密码要求检查
    function updatePasswordRequirements(password) {
        const requirements = {
            'length-req': password.length >= 6,
            'letter-req': /[a-zA-Z]/.test(password),
            'number-req': /[0-9]/.test(password),
            'special-req': /[^a-zA-Z0-9]/.test(password)
        };
        
        Object.entries(requirements).forEach(([id, met]) => {
            const element = document.getElementById(id);
            if (met) {
                element.classList.add('met');
            } else {
                element.classList.remove('met');
            }
        });
    }
    
    // 输入框聚焦效果
    [currentPasswordInput, newPasswordInput, confirmPasswordInput].forEach(input => {
        input.addEventListener('focus', function() {
            this.closest('.input-group').classList.add('focused');
        });
        
        input.addEventListener('blur', function() {
            this.closest('.input-group').classList.remove('focused');
        });
    });
});

function showMessage(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 
                     type === 'error' ? 'alert-danger' : 
                     type === 'warning' ? 'alert-warning' : 'alert-info';
    const iconClass = type === 'success' ? 'fa-check-circle' : 
                     type === 'error' ? 'fa-exclamation-circle' : 
                     type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
    
    const alertHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas ${iconClass}"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    // 找到或创建消息容器
    let container = document.querySelector('.alert-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'alert-container';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1050; max-width: 400px;';
        document.body.appendChild(container);
    }
    
    container.innerHTML = alertHTML;
    
    // 自动关闭消息
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endblock %} 